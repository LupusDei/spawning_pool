#!/usr/bin/env bash
#
# spawn-project (sp) - Create a pool of agent workspaces for a project
#
# Usage: spawn-project <project-name> <github-repo-url> <num-agents>
#
# Creates:
#   <project-name>_pool/
#     runner/          - Runner workspace (initializes beads)
#     spawn-1/         - Agent workspace 1
#     spawn-2/         - Agent workspace 2
#     ...
#

set -euo pipefail

# Get the directory where this script lives (for finding PRIME.md)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SPAWNING_POOL_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

usage() {
    cat <<EOF
Usage: spawn-project <project-name> <github-repo-url> <num-agents>

Arguments:
    project-name     Name for the pool (creates <name>_pool directory)
    github-repo-url  Git remote URL to clone
    num-agents       Number of agent workspaces to create

Example:
    spawn-project myapp git@github.com:user/myapp.git 3

This will create:
    myapp_pool/
    ├── runner/myapp/     (beads initialized here)
    ├── spawn-1/myapp/    (claude launched here)
    ├── spawn-2/myapp/    (claude launched here)
    └── spawn-3/myapp/    (claude launched here)
EOF
    exit 1
}

# Validate arguments
if [[ $# -ne 3 ]]; then
    log_error "Expected 3 arguments, got $#"
    usage
fi

PROJECT_NAME="$1"
REPO_URL="$2"
NUM_AGENTS="$3"

# Validate num_agents is a positive integer
if ! [[ "$NUM_AGENTS" =~ ^[1-9][0-9]*$ ]]; then
    log_error "num-agents must be a positive integer, got: $NUM_AGENTS"
    exit 1
fi

# Extract repo name from URL (handles both HTTPS and SSH formats)
REPO_NAME=$(basename "$REPO_URL" .git)

# Define pool directory
POOL_DIR="${PROJECT_NAME}_pool"
START_DIR="$(pwd)"

log_info "Creating pool: $POOL_DIR"
log_info "Repository: $REPO_URL (name: $REPO_NAME)"
log_info "Agent count: $NUM_AGENTS"
echo

# Check if pool directory already exists
if [[ -d "$POOL_DIR" ]]; then
    log_error "Directory '$POOL_DIR' already exists"
    exit 1
fi

# Create pool directory structure
mkdir -p "$POOL_DIR"
cd "$POOL_DIR"
POOL_PATH="$(pwd)"

# Create runner directory
log_info "Creating runner workspace..."
mkdir -p runner
cd runner
git clone "$REPO_URL"
log_success "Cloned repo into runner/"

# Initialize beads in runner
cd "$REPO_NAME"
log_info "Initializing beads in runner..."
bd init

# Copy PRIME.md into .beads/ for context recovery
if [[ -f "$SPAWNING_POOL_DIR/PRIME.md" ]]; then
    cp "$SPAWNING_POOL_DIR/PRIME.md" .beads/PRIME.md
    log_success "Copied PRIME.md to .beads/"
else
    log_warn "PRIME.md not found at $SPAWNING_POOL_DIR/PRIME.md"
fi

git add .beads/ AGENTS.md .gitattributes 2>/dev/null || git add .beads/ 2>/dev/null || true
git commit -m "Initialize beads issue tracking" 2>/dev/null || log_warn "Nothing to commit (beads may already exist)"
git push 2>/dev/null || log_warn "Push failed or nothing to push"
log_success "Beads initialized and pushed"

cd "$POOL_PATH"

# Create agent spawn directories
log_info "Creating $NUM_AGENTS agent workspaces..."
for i in $(seq 1 "$NUM_AGENTS"); do
    SPAWN_DIR="spawn-$i"
    log_info "Setting up $SPAWN_DIR..."
    mkdir -p "$SPAWN_DIR"
    cd "$SPAWN_DIR"
    git clone "$REPO_URL"
    cd "$REPO_NAME"

    # Pull latest (including beads from runner) and sync
    git pull
    bd sync --import-only --no-daemon 2>/dev/null || bd sync --import-only 2>/dev/null || log_warn "bd sync failed for $SPAWN_DIR"

    log_success "$SPAWN_DIR ready"
    cd "$POOL_PATH"
done

echo
log_success "Pool created successfully!"
echo
log_info "Launching Claude in each agent workspace..."
echo

# Launch claude in each spawn directory (not runner)
for i in $(seq 1 "$NUM_AGENTS"); do
    SPAWN_DIR="spawn-$i"
    REPO_PATH="$POOL_PATH/$SPAWN_DIR/$REPO_NAME"

    log_info "Launching Claude in $SPAWN_DIR..."

    # Open new terminal window/tab and run claude
    # This uses osascript on macOS to open new Terminal windows
    if [[ "$(uname)" == "Darwin" ]]; then
        osascript <<EOF
tell application "Terminal"
    do script "cd '$REPO_PATH' && claude"
    activate
end tell
EOF
    else
        # On Linux, try common terminal emulators
        if command -v gnome-terminal &>/dev/null; then
            gnome-terminal --working-directory="$REPO_PATH" -- claude &
        elif command -v xterm &>/dev/null; then
            xterm -e "cd '$REPO_PATH' && claude" &
        else
            log_warn "Could not launch terminal for $SPAWN_DIR. Please run 'claude' manually in: $REPO_PATH"
        fi
    fi
done

echo
log_success "All agents launched!"
echo
log_info "Pool structure:"
echo "  $POOL_DIR/"
echo "  ├── runner/$REPO_NAME/  (beads master - do not run claude here)"
for i in $(seq 1 "$NUM_AGENTS"); do
    if [[ $i -eq $NUM_AGENTS ]]; then
        echo "  └── spawn-$i/$REPO_NAME/  (claude running)"
    else
        echo "  ├── spawn-$i/$REPO_NAME/  (claude running)"
    fi
done
echo
log_info "Use 'bd sync' in runner to collect all agent work"
